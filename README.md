# Hacks
These are all "hacks" that I have spent countless of hours on realizing because of the abundant and often contradictory information found on the internet (stackxchange, etc.), but also erroneous solutions generated by, e.g., ChatGPT.
## Next Up
- Authentication
  - **Custom Auth** for own user database
  - OpenID (Keycloak) for authentication
  - Sources to start:
    - https://www.youtube.com/watch?v=TgsHxDT0VXw
    - https://www.youtube.com/watch?v=7C8dUZeKsE0
    - https://forums.oracle.com/ords/apexds/post/how-to-log-in-with-user-credentials-from-database-table-6626
    - https://www.google.com/search?client=firefox-b-d&q=oracle+apex+user+authentication+by+table
## Report Pages
### Interactive Reports (IR)
#### Conditional Edit Column
##### Use Case
Current user shall be able to edit report rows based on condition(s).
##### Example
- **Context**: The example is based on an IR sourced from a regular table, the editing takes place via a modal dialog.
- **Edit Condition**: OPEN_ID column contains same user name as current user name.
- **Style**: Edit column with pencil style icon to edit rows where authorized in a modal dialog[^1].

The built-in link attribute of a page body doesn't do the job, because with its condition statements, the whole link column is either turned on or off, no can do for individual rows.
That's why it has to be done with a combination of SQL and a helper column that will contain the conditional edit buttons.

###### Report Page Body
The SQL in the **report page** body selects the existing table data and creates the helper column ```EDIT_LINK```. The column is empty where the condition is not met, it contains the URL (via ```apex_page.get_url()```[^2]) and the icon (fa-edit) where the condition is met.
```
select *,
       CASE lower(OPEN_ID)
         when lower(:APP_USER) THEN
            '<a href="'||apex_page.get_url(p_page => '<modal dialog page id>', p_items => 'p<modal dialog page id>_id', p_values => ID)||'"><span class="fa fa-edit"></span></a>'
        ELSE NULL
    END EDIT_LINK
  from <table name>
```
###### Helper Column ```EDIT_LINK```
The column text is 
```EDIT_LINK``` Column settings:
- **Link type**: ```Link```
- **Heading**: ```&nbsp;```
- **Link**
  - **Target**: ```Page <x>```
  - **Link Text**: ```&EDIT_LINK.``` (see [^3] and [^4])

#### Modal Dialog: Set Value Upon Dialog Closure
This is a topic I found especially hard to deal with: I want to set a creation date in a table when the entry is actually created. Doing this with a table setting of column and default value, it somehow produced an empty cell. So I found the following solution:
1. Go to modal page
2. Create a process in category _Processing_ named, e.g., _Set Value_ of type _Execute Code_. It should be put _after_ the standard modal form proceses _Process Form_.
3. Enter the following PL/SQL Code:
   ```
   :<modal dialog var> := <desired value>;
   ```
   I wanted to have a creation time, so, for modal dialog page 3 (P3_CREATED_ON refers to CREATED_ON on the source page and from there to the source table column of the same name):
   ```
   :P3_CREATED_ON := sysdate;
   ```
   If you want to execute SQL:[^6]
   ```
   update <table name>
   set <column name> = <desired value>
   where <PK id variable name>= :<modal dialog ID variable name>;
   ```
#### Suppress Message After Modal Dialog Create
The message can be styled (I didn't figure out how to suppress it completely) via a theme JS API.[^5]
The code simply needs to be put into the events of the modal dialog page's source page, unter _Page Load_, as a _Dynamic Action_ the _Action Type_ of which should be _Execute JavaScript Code_.

## Simple Auditing
If you want to set up simple AUditing (created/updated information per row), the corresponding columns and a trigger need to be created per table.

The following script (replace ```table_name```) was created by Deepseek:
```
-- Script for audit implementation with dynamic table name
-- Usage in: APEX > SQL Workshop > SQL Scripts

DECLARE
  -- Get table name via substitution variable
  v_table_name VARCHAR2(128) := UPPER(TRIM(':TABLE_NAME')); -- User will be prompted for input

  -- Procedure to add audit columns
  PROCEDURE add_audit_columns(p_table VARCHAR2) IS
  BEGIN
    htp.p('=== Adding audit columns to ' || p_table || ' ===');
    
    BEGIN
      EXECUTE IMMEDIATE 'ALTER TABLE "' || p_table || '" ADD (
        "CREATED" TIMESTAMP WITH TIME ZONE,
        "CREATED_BY" VARCHAR2(255),
        "UPDATED" TIMESTAMP WITH TIME ZONE,
        "UPDATED_BY" VARCHAR2(255)
      )';
      htp.p('Audit columns added successfully');
    EXCEPTION
      WHEN OTHERS THEN
        IF SQLCODE = -1430 THEN -- Column already exists
          htp.p('Note: Audit columns already exist');
        ELSE
          htp.p('Error: ' || SQLERRM);
          RAISE;
        END IF;
    END;
  END;

  -- Procedure to create the trigger
  PROCEDURE create_audit_trigger(p_table VARCHAR2) IS
    l_sql VARCHAR2(4000);
  BEGIN
    l_sql := '
    CREATE OR REPLACE TRIGGER "' || p_table || '_TRG_AUDIT"
    BEFORE INSERT OR UPDATE ON "' || p_table || '"
    FOR EACH ROW
    DECLARE
      l_user VARCHAR2(255);
    BEGIN
      l_user := COALESCE(
        SYS_CONTEXT(''APEX$SESSION'',''APP_USER''),
        SYS_CONTEXT(''USERENV'',''SESSION_USER'')
      );
      IF INSERTING THEN
        :NEW."CREATED" := SYSTIMESTAMP;
        :NEW."CREATED_BY" := l_user;
        :NEW."UPDATED" := SYSTIMESTAMP;
        :NEW."UPDATED_BY" := l_user;
      ELSIF UPDATING THEN
        :NEW."UPDATED" := SYSTIMESTAMP;
        :NEW."UPDATED_BY" := l_user;
        :NEW."CREATED" := :OLD."CREATED";
        :NEW."CREATED_BY" := :OLD."CREATED_BY";
      END IF;
    END;';
    
    EXECUTE IMMEDIATE l_sql;
    htp.p('Trigger ' || p_table || '_TRG_AUDIT created successfully');
  EXCEPTION
    WHEN OTHERS THEN
      htp.p('Trigger error: ' || SQLERRM);
      RAISE;
  END;

BEGIN
  -- Input validation
  --IF v_table_name IS NULL OR v_table_name NOT LIKE 'SDV\_%' ESCAPE '\' THEN
  --  htp.p('=== ERROR: Invalid table name! Must start with "SDV_". ===');
  --  RETURN;
  --END IF;

  -- Main processing
  add_audit_columns(v_table_name);
  create_audit_trigger(v_table_name);
  
  COMMIT;
  htp.p('=== SUCCESS: Audit logic implemented for ' || v_table_name || ' ===');
EXCEPTION
  WHEN OTHERS THEN
    ROLLBACK;
    htp.p('=== ERROR: ' || SQLERRM || ' ===');
END;
/
```
Additionally, the following resources can be consulted:
- [Methods on Tables to include audit functionality on a table](https://apex.oracle.com/ideas/FR-3247)
- [How to Pass APP_USER to a database trigger for auditing](https://forums.oracle.com/ords/apexds/post/how-to-pass-app-user-to-a-database-trigger-for-auditing-2402)
- [APEX Modified date Column update](https://forums.oracle.com/ords/apexds/post/apex-modified-date-column-update-7327)
- [CREATED_ON column using Source: Automatic Row Processing (DML)](https://forums.oracle.com/ords/apexds/post/created-on-column-using-source-automatic-row-processing-dml-4696)

# Sources
[^1]: https://forums.oracle.com/ords/apexds/post/how-to-open-modal-dialog-page-from-hyperlink-6555
[^2]: https://docs.oracle.com/en/database/oracle/apex/22.1/aeapi/GET_URL-Function.html
[^3]: https://forums.oracle.com/ords/apexds/post/how-to-make-link-text-conditional-6681
[^4]: https://docs.oracle.com/en/database/oracle/apex/24.1/htmdb/about-using-substitution-strings.html#GUID-C47D5D9B-3476-48EA-A0B1-DBA96E6E283B
[^5]: https://apex.oracle.com/pls/apex/apex_pm/r/ut/javascript-apis
[^6]: https://forums.oracle.com/ords/apexds/post/how-can-i-perform-an-sql-statement-insert-data-into-table-u-4869
